{% extends "base.html" %}

{% block title %}WhatUpSF - Live Music Map{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
    /* Custom Leaflet Dark Theme Styles */
    .leaflet-popup-content-wrapper {
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(10px);
        color: #f0f0f0;
        border-radius: 12px;
        border: 1px solid rgba(0, 240, 255, 0.3);
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.3);
    }

    .leaflet-popup-tip {
        background: rgba(18, 18, 18, 0.95);
        border: 1px solid rgba(0, 240, 255, 0.3);
    }

    .leaflet-popup-content h1 {
        color: #00f0ff;
        text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 0 12px 0;
    }

    .leaflet-popup-content h2 {
        color: #ff00ff;
        font-size: 1rem;
        margin: 8px 0;
    }

    .leaflet-popup-content a {
        color: #00f0ff;
        text-decoration: none;
        transition: color 0.3s;
    }

    .leaflet-popup-content a:hover {
        color: #00d4e0;
        text-shadow: 0 0 8px rgba(0, 240, 255, 0.7);
    }

    .leaflet-container a.leaflet-popup-close-button {
        color: #ff00ff;
        font-size: 24px;
        font-weight: bold;
        padding: 8px;
        transition: all 0.3s;
    }

    .leaflet-container a.leaflet-popup-close-button:hover {
        color: #ff5500;
        text-shadow: 0 0 10px rgba(255, 0, 255, 0.7);
    }

    .leaflet-bar {
        background: rgba(18, 18, 18, 0.9);
        border: 1px solid rgba(0, 240, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
        border-radius: 8px;
    }

    .leaflet-bar a {
        background: rgba(18, 18, 18, 0.9);
        color: #00f0ff;
        border-bottom: 1px solid rgba(0, 240, 255, 0.2);
        transition: all 0.3s;
    }

    .leaflet-bar a:hover {
        background: rgba(0, 240, 255, 0.1);
        color: #00f0ff;
        box-shadow: inset 0 0 10px rgba(0, 240, 255, 0.3);
    }

    .leaflet-bar a:first-child {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }

    .leaflet-bar a:last-child {
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
        border-bottom: none;
    }

    .locate-btn {
        font-size: 18px;
        line-height: 34px;
    }

    /* Map container */
    #map {
        height: calc(100vh - 64px);
        width: 100%;
    }

    /* Filter drawer for mobile */
    #filter-drawer {
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
    }

    #filter-drawer.open {
        transform: translateX(0);
    }

    /* Bottom sheet for mobile */
    #event-bottom-sheet {
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
    }

    #event-bottom-sheet.open {
        transform: translateY(0);
    }

    /* Touch-friendly controls */
    @media (max-width: 768px) {
        button, a, input[type="checkbox"] {
            min-height: 44px;
            min-width: 44px;
        }
    }

    /* Loading spinner */
    .spinner {
        border: 3px solid rgba(0, 240, 255, 0.2);
        border-top: 3px solid #00f0ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Cluster number styling */
    .cluster-icon {
        background: transparent !important;
        border: none !important;
    }

    .cluster-number {
        background: rgba(0, 102, 255, 0.95);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        border: 2px solid #00f0ff;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.6);
        cursor: pointer;
        transition: all 0.3s ease;
        animation: fadeIn 0.3s ease-in-out;
    }

    .cluster-number:hover {
        transform: scale(1.2);
        box-shadow: 0 0 25px rgba(0, 240, 255, 1);
        background: rgba(0, 240, 255, 0.95);
    }

    /* Disable animations on venue and cluster markers to prevent position glitches */
    .venue-marker,
    .cluster-marker {
        animation: none !important;
        transition: none !important;
    }

    /* Red jewel blinking effect - smooth sinusoidal pulsing */
    .leaflet-interactive.venue-jewel-blink {
        animation: blinkRed 2s linear infinite;
    }

    /* Selected venue - no blinking */
    .leaflet-interactive.venue-selected {
        animation: none !important;
        filter: drop-shadow(0 0 8px rgba(255, 0, 255, 1));
    }

    /* Random delays for twinkling effect - different timings */
    .venue-jewel-blink:nth-child(7n+1) { animation-delay: 0s; animation-duration: 1.3s; }
    .venue-jewel-blink:nth-child(7n+2) { animation-delay: 0.2s; animation-duration: 1.6s; }
    .venue-jewel-blink:nth-child(7n+3) { animation-delay: 0.4s; animation-duration: 1.4s; }
    .venue-jewel-blink:nth-child(7n+4) { animation-delay: 0.6s; animation-duration: 1.7s; }
    .venue-jewel-blink:nth-child(7n+5) { animation-delay: 0.8s; animation-duration: 1.5s; }
    .venue-jewel-blink:nth-child(7n+6) { animation-delay: 1.0s; animation-duration: 1.8s; }
    .venue-jewel-blink:nth-child(7n) { animation-delay: 1.2s; animation-duration: 1.2s; }

    @keyframes blinkRed {
        0% {
            opacity: 1;
            filter: drop-shadow(0 0 6px rgba(255, 0, 0, 1))
                    drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
        }
        12.5% {
            opacity: 0.93;
            filter: drop-shadow(0 0 5.5px rgba(255, 0, 0, 0.93))
                    drop-shadow(0 0 9px rgba(255, 0, 0, 0.74));
        }
        25% {
            opacity: 0.8;
            filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.8))
                    drop-shadow(0 0 7px rgba(255, 0, 0, 0.6));
        }
        37.5% {
            opacity: 0.67;
            filter: drop-shadow(0 0 4px rgba(255, 0, 0, 0.67))
                    drop-shadow(0 0 6px rgba(255, 0, 0, 0.5));
        }
        50% {
            opacity: 0.6;
            filter: drop-shadow(0 0 3px rgba(255, 0, 0, 0.6))
                    drop-shadow(0 0 5px rgba(255, 0, 0, 0.4));
        }
        62.5% {
            opacity: 0.67;
            filter: drop-shadow(0 0 4px rgba(255, 0, 0, 0.67))
                    drop-shadow(0 0 6px rgba(255, 0, 0, 0.5));
        }
        75% {
            opacity: 0.8;
            filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.8))
                    drop-shadow(0 0 7px rgba(255, 0, 0, 0.6));
        }
        87.5% {
            opacity: 0.93;
            filter: drop-shadow(0 0 5.5px rgba(255, 0, 0, 0.93))
                    drop-shadow(0 0 9px rgba(255, 0, 0, 0.74));
        }
        100% {
            opacity: 1;
            filter: drop-shadow(0 0 6px rgba(255, 0, 0, 1))
                    drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
        }
    }

    /* Keep animation only for popup markers (not circles) */
    .leaflet-marker-icon,
    .leaflet-marker-shadow {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Pulse animation for selected markers */
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        50% {
            box-shadow: 0 0 0 15px rgba(255, 0, 0, 0);
        }
    }

    /* Smooth popup animation */
    .leaflet-popup {
        animation: slideUpFade 0.3s ease-out;
    }

    @keyframes slideUpFade {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-64px)] relative">
    <!-- Desktop Filter Sidebar -->
    <aside id="filter-sidebar" class="hidden lg:flex flex-col w-80 glass-card border-r border-gray-800 p-6 space-y-6 overflow-y-auto">
        <div class="space-y-6">
            <h2 class="text-2xl font-bold text-neon-cyan neon-text">Filters</h2>

            <!-- Date Range -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Date Range</label>
                <input type="date" id="date-from" class="w-full px-4 py-2 bg-midnight-800 border border-gray-700 rounded-lg text-gray-100 focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/30 transition-all">
                <input type="date" id="date-to" class="w-full px-4 py-2 bg-midnight-800 border border-gray-700 rounded-lg text-gray-100 focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/30 transition-all">
            </div>

            <!-- Price Range -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Price Range</label>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-cyan focus:ring-neon-cyan/30" value="free">
                        <span class="text-gray-300 group-hover:text-neon-cyan transition-colors">Free</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-magenta focus:ring-neon-magenta/30" value="0-10">
                        <span class="text-gray-300 group-hover:text-neon-magenta transition-colors">Under $10</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-blue focus:ring-neon-blue/30" value="10-30">
                        <span class="text-gray-300 group-hover:text-neon-blue transition-colors">$10 - $30</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-purple focus:ring-neon-purple/30" value="30+">
                        <span class="text-gray-300 group-hover:text-neon-purple transition-colors">$30+</span>
                    </label>
                </div>
            </div>

            <!-- Venue Type -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Venue Type</label>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-cyan focus:ring-neon-cyan/30" value="main-stage">
                        <span class="text-gray-300 group-hover:text-neon-cyan transition-colors">Main Stage</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-magenta focus:ring-neon-magenta/30" value="bar-club">
                        <span class="text-gray-300 group-hover:text-neon-magenta transition-colors">Bar/Club</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-blue focus:ring-neon-blue/30" value="outdoor">
                        <span class="text-gray-300 group-hover:text-neon-blue transition-colors">Outdoor</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-3 pt-4">
                <button id="apply-filters" class="flex-1 px-4 py-2 bg-neon-cyan text-midnight-900 font-semibold rounded-lg hover:bg-neon-blue hover:shadow-neon-cyan transition-all duration-300">
                    Apply
                </button>
                <button id="clear-filters" class="flex-1 px-4 py-2 bg-midnight-700 text-gray-300 font-semibold rounded-lg hover:bg-midnight-600 hover:text-white transition-all duration-300">
                    Clear
                </button>
            </div>

            <!-- Event Count -->
            <div class="pt-4 border-t border-gray-800">
                <p class="text-sm text-gray-400">
                    Showing <span id="event-count" class="text-neon-cyan font-bold">0</span> events
                </p>
            </div>
        </div>
    </aside>

    <!-- Map Container -->
    <div class="flex-1 relative">
        <div id="map"></div>

        <!-- Mobile Filter Button (floating) -->
        <button id="mobile-filter-btn" class="lg:hidden fixed bottom-20 left-4 z-[1000] p-4 bg-neon-magenta text-white rounded-full shadow-neon-magenta hover:bg-neon-purple transition-all duration-300 animate-pulse-neon">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
            </svg>
        </button>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[1000] glass-card p-8 rounded-xl">
            <div class="spinner mx-auto"></div>
            <p class="mt-4 text-neon-cyan text-center">Loading events...</p>
        </div>
    </div>

    <!-- Mobile Filter Drawer -->
    <aside id="filter-drawer" class="lg:hidden fixed top-16 right-0 bottom-0 w-80 z-[1001] glass-card border-l border-gray-800 p-6 space-y-6 overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-neon-cyan neon-text">Filters</h2>
            <button id="close-filter-drawer" class="p-2 hover:bg-midnight-700 rounded-lg transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Same filter content as desktop -->
        <div class="space-y-6">
            <!-- Date Range -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Date Range</label>
                <input type="date" id="mobile-date-from" class="w-full px-4 py-2 bg-midnight-800 border border-gray-700 rounded-lg text-gray-100 focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/30">
                <input type="date" id="mobile-date-to" class="w-full px-4 py-2 bg-midnight-800 border border-gray-700 rounded-lg text-gray-100 focus:border-neon-cyan focus:ring-2 focus:ring-neon-cyan/30">
            </div>

            <!-- Price Range -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Price Range</label>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-cyan" value="free">
                        <span class="text-gray-300 group-hover:text-neon-cyan transition-colors">Free</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-magenta" value="0-10">
                        <span class="text-gray-300 group-hover:text-neon-magenta transition-colors">Under $10</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-blue" value="10-30">
                        <span class="text-gray-300 group-hover:text-neon-blue transition-colors">$10 - $30</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-price w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-purple" value="30+">
                        <span class="text-gray-300 group-hover:text-neon-purple transition-colors">$30+</span>
                    </label>
                </div>
            </div>

            <!-- Venue Type -->
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-gray-300">Venue Type</label>
                <div class="space-y-2">
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-cyan" value="main-stage">
                        <span class="text-gray-300 group-hover:text-neon-cyan transition-colors">Main Stage</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-magenta" value="bar-club">
                        <span class="text-gray-300 group-hover:text-neon-magenta transition-colors">Bar/Club</span>
                    </label>
                    <label class="flex items-center space-x-3 cursor-pointer group">
                        <input type="checkbox" class="mobile-filter-venue-type w-5 h-5 rounded border-gray-700 bg-midnight-800 text-neon-blue" value="outdoor">
                        <span class="text-gray-300 group-hover:text-neon-blue transition-colors">Outdoor</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <button id="mobile-apply-filters" class="flex-1 px-4 py-3 bg-neon-cyan text-midnight-900 font-semibold rounded-lg hover:bg-neon-blue hover:shadow-neon-cyan transition-all">
                    Apply
                </button>
                <button id="mobile-clear-filters" class="flex-1 px-4 py-3 bg-midnight-700 text-gray-300 font-semibold rounded-lg hover:bg-midnight-600 hover:text-white transition-all">
                    Clear
                </button>
            </div>

            <!-- Event Count -->
            <div class="pt-4 border-t border-gray-800">
                <p class="text-sm text-gray-400">
                    Showing <span id="mobile-event-count" class="text-neon-cyan font-bold">0</span> events
                </p>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Map Configuration -->
<script>
    window.MAP_CONFIG = {
        useConvexHull: {{ use_convex_hull|lower }}
    };
</script>

<!-- Modern ES6+ JavaScript Modules with Dark Tiles -->
<script type="module" src="/static/js/map-app.js?v=20260208b"></script>
{% endblock %}
